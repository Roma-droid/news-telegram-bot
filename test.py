import telebot
import requests
import json

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BOT_TOKEN = '8164909440:AAHemeo02iKSmQaTev7Q7k_W8tEeMJ7IrxE'  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
LM_STUDIO_URL = "http://localhost:1234/v1/chat/completions"  # URL LM Studio API
HEADERS = {"Content-Type": "application/json"}

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
bot = telebot.TeleBot(BOT_TOKEN)

def generate_news_with_ai(topic="–Ω–æ–≤–æ—Å—Ç—å"):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é LM Studio API –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ"""
    # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–µ–º
    prompts = {
        "–Ω–æ–≤–æ—Å—Ç—å": (
            "–ù–∞–ø–∏—à–∏ —Ä–µ–∞–ª—å–Ω—É—é –Ω–æ–≤–æ—Å—Ç—å –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ç–µ–º—É. "
            "–ò—Å–ø–æ–ª—å–∑—É–π –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏–∑–ª–æ–∂–µ–Ω–∏—è. "
            "–§–æ—Ä–º–∞—Ç: –∫—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∑–∞—Ç–µ–º 2-3 –∞–±–∑–∞—Ü–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è."
        ),
        "–≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–µ": (
            "–ù–∞–ø–∏—à–∏ –Ω–æ–≤–æ—Å—Ç—å –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö –≤ –æ–±–ª–∞—Å—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏—è. "
            "–í–∫–ª—é—á–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–∞—É—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã —É—á–µ–Ω—ã—Ö. "
            "–û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —É–¥–µ–ª–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º –¥–ª—è —ç–∫–æ—Å–∏—Å—Ç–µ–º –∏ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞. "
            "–§–æ—Ä–º–∞—Ç: –∫—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∑–∞—Ç–µ–º 2-3 –∞–±–∑–∞—Ü–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è."
        ),
        "–Ω–∞–≤–æ–¥–Ω–µ–Ω–∏–µ": (
            "–ù–∞–ø–∏—à–∏ –Ω–æ–≤–æ—Å—Ç—å –æ —Å–µ—Ä—å–µ–∑–Ω–æ–º –Ω–∞–≤–æ–¥–Ω–µ–Ω–∏–∏ –≤ –∫–∞–∫–æ–º-–ª–∏–±–æ —Ä–µ–≥–∏–æ–Ω–µ –º–∏—Ä–∞. "
            "–£–∫–∞–∂–∏ —Ä–µ–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ, –ø—Ä–∏—á–∏–Ω—ã –Ω–∞–≤–æ–¥–Ω–µ–Ω–∏—è (–ª–∏–≤–Ω–∏, —Ç–∞—è–Ω–∏–µ –ª–µ–¥–Ω–∏–∫–æ–≤, —É—Ä–∞–≥–∞–Ω –∏ —Ç.–¥.), "
            "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏—Ö, –º–∞—Å—à—Ç–∞–±—ã —Ä–∞–∑—Ä—É—à–µ–Ω–∏–π –∏ –¥–µ–π—Å—Ç–≤–∏—è —Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–ª—É–∂–±. "
            "–î–æ–±–∞–≤—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è—Ö –∏ –º–µ—Ä–∞—Ö –ø–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—é –±—É–¥—É—â–∏—Ö –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ. "
            "–§–æ—Ä–º–∞—Ç: –∫—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∑–∞—Ç–µ–º 2-3 –∞–±–∑–∞—Ü–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è."
        )
    }
    
    prompt = prompts.get(topic, prompts["–Ω–æ–≤–æ—Å—Ç—å"])
    
    data = {
        "messages": [
            {"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∂—É—Ä–Ω–∞–ª–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞—Ö –∏ –∫–ª–∏–º–∞—Ç–µ."},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.7,
        "max_tokens": 650,
        "stop": ["<|im_end|>"]
    }
    
    try:
        response = requests.post(LM_STUDIO_URL, headers=HEADERS, data=json.dumps(data))
        response.raise_for_status()
        return response.json()['choices'][0]['message']['content']
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏: {e}")
        return None

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥
@bot.message_handler(commands=['start'])
def send_welcome(message):
    welcome_text = (
        "üåç –ü—Ä–∏–≤–µ—Ç! –Ø –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –±–æ—Ç —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º.\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/news - –°–ª—É—á–∞–π–Ω–∞—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å\n"
        "/global_warming - –ù–æ–≤–æ—Å—Ç–∏ –æ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–∏\n"
        "/flood - –ù–æ–≤–æ—Å—Ç–∏ –æ –Ω–∞–≤–æ–¥–Ω–µ–Ω–∏—è—Ö –∏ –ø–∞–≤–æ–¥–∫–∞—Ö\n\n"
        "–í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!"
    )
    bot.reply_to(message, welcome_text)

@bot.message_handler(commands=['news'])
def send_news(message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏"""
    msg = bot.send_message(message.chat.id, "üì° –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏...")
    news_text = generate_news_with_ai()
    
    if news_text:
        bot.edit_message_text(
            chat_id=message.chat.id,
            message_id=msg.message_id,
            text=f"üì∞ **–°–≤–µ–∂–∏–π –≤—ã–ø—É—Å–∫**\n\n{news_text}",
            parse_mode='Markdown'
        )
    else:
        bot.edit_message_text(
            chat_id=message.chat.id,
            message_id=msg.message_id,
            text="‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )

@bot.message_handler(commands=['global_warming'])
def send_climate_news(message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ—Å—Ç–∏ –æ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–∏"""
    msg = bot.send_message(message.chat.id, "üå°Ô∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ...")
    news_text = generate_news_with_ai("–≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–µ")
    
    if news_text:
        bot.edit_message_text(
            chat_id=message.chat.id,
            message_id=msg.message_id,
            text=f"üî• **–ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç**\n\n{news_text}",
            parse_mode='Markdown'
        )
    else:
        bot.edit_message_text(
            chat_id=message.chat.id,
            message_id=msg.message_id,
            text="‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )

@bot.message_handler(commands=['flood'])
def send_flood_news(message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ—Å—Ç–∏ –æ –Ω–∞–≤–æ–¥–Ω–µ–Ω–∏–∏"""
    msg = bot.send_message(message.chat.id, "üåßÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≥–∏–¥—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É...")
    news_text = generate_news_with_ai("–Ω–∞–≤–æ–¥–Ω–µ–Ω–∏–µ")
    
    if news_text:
        bot.edit_message_text(
            chat_id=message.chat.id,
            message_id=msg.message_id,
            text=f"üåä **–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏: –ù–∞–≤–æ–¥–Ω–µ–Ω–∏–µ**\n\n{news_text}",
            parse_mode='Markdown'
        )
    else:
        bot.edit_message_text(
            chat_id=message.chat.id,
            message_id=msg.message_id,
            text="‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–≤–æ–¥–Ω–µ–Ω–∏—è—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == '__main__':
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.infinity_polling()